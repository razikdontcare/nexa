<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nexa Bot Panel</title>
  <script src="/vendor/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; color: #111; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .status { padding: .25rem .5rem; border-radius: .5rem; background: #eee; font-weight: 600; }
    .status.open { background: #d1fadf; color: #065f46; }
    .status.close { background: #fee2e2; color: #991b1b; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; }
    .card { border: 1px solid #e5e7eb; border-radius: .5rem; padding: 1rem; }
    canvas { image-rendering: pixelated; }
    label { display:block; margin:.5rem 0 .25rem; font-weight:600; }
    input[type="text"] { width: 100%; padding:.5rem; border:1px solid #ddd; border-radius:.375rem; }
    button { padding:.5rem 1rem; border:1px solid #ddd; border-radius:.375rem; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; }
    .row { display:flex; gap:.5rem; }
    small { color:#6b7280; }
  </style>
  <script>
    let statusEl, qrCanvas, prefixInput, ownerInput, saveBtn, phoneInput, pairBtn, qrContainer

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts)
      if (!res.ok) throw new Error(await res.text())
      return res.json()
    }

    function setStatus(s) {
      statusEl.textContent = s
      statusEl.className = 'status ' + s
      if (s === 'open') {
        // hide qr when connected
        qrContainer.style.display = 'none'
      } else {
        qrContainer.style.display = ''
      }
    }

    async function drawQR(qr) {
      if (!qr) return
      try {
        if (window.QRCode && typeof QRCode.toCanvas === 'function') {
          // qrcode.min.js attaches QRCode global
          await QRCode.toCanvas(qrCanvas, qr, { width: 260 })
        } else if (qrCanvas && qrCanvas.getContext) {
          // fallback: render raw text if library missing
          const ctx = qrCanvas.getContext('2d')
          ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height)
          ctx.fillStyle = '#111'
          ctx.font = '12px monospace'
          ctx.fillText('QR library not loaded', 10, 20)
        }
      } catch (e) {
        console.error('Failed to draw QR:', e)
      }
    }

    async function init() {
      statusEl = document.getElementById('status')
      qrCanvas = document.getElementById('qr')
      prefixInput = document.getElementById('prefix')
      ownerInput = document.getElementById('owner')
      saveBtn = document.getElementById('save')
      phoneInput = document.getElementById('phone')
      pairBtn = document.getElementById('pair')
      qrContainer = document.getElementById('qr-container')

      // Load config
      try {
        const cfg = await fetchJSON('/api/config')
        prefixInput.value = cfg.prefix || '!'
        ownerInput.value = cfg.ownerJid || ''
      } catch {}

      // Load status snapshot
      try {
        const s = await fetchJSON('/api/status')
        setStatus(s.status || 'unknown')
      } catch {}

      // Bind save config
      saveBtn.onclick = async () => {
        const payload = { prefix: prefixInput.value.trim(), ownerJid: ownerInput.value.trim() || null }
        const res = await fetchJSON('/api/config', {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        })
        alert('Saved!')
      }

      pairBtn.onclick = async () => {
        try {
          const phone = phoneInput.value.trim()
          const res = await fetchJSON('/api/pair?phone=' + encodeURIComponent(phone), { method: 'POST' })
          alert('Pairing code: ' + (res.code || ''))
        } catch (e) {
          alert('Failed: ' + e)
        }
      }

      // SSE events
      const es = new EventSource('/events')
      es.addEventListener('status', (ev) => {
        try { const data = JSON.parse(ev.data); setStatus(data.status || 'unknown') } catch {}
      })
      es.addEventListener('qr', async (ev) => {
        try { const data = JSON.parse(ev.data); await drawQR(data.qr) } catch {}
      })
    }

    addEventListener('DOMContentLoaded', init)
  </script>
</head>
<body>
  <header>
    <h1>Nexa Bot Panel</h1>
    <div class="status" id="status">unknown</div>
  </header>
  <div class="grid">
    <div class="card" id="qr-container">
      <h3>Scan QR</h3>
      <canvas id="qr" width="260" height="260"></canvas>
      <p><small>If not showing, ensure WA_PAIRING_MODE=qr and the bot is running.</small></p>
    </div>
    <div class="card">
      <h3>Config</h3>
      <label for="prefix">Prefix</label>
      <input id="prefix" type="text" placeholder="!" />
      <label for="owner">Owner JID</label>
      <input id="owner" type="text" placeholder="12345@s.whatsapp.net" />
      <div class="row" style="margin-top: .75rem;">
        <button id="save">Save</button>
      </div>
      <h3 style="margin-top:1.5rem;">Pairing (optional)</h3>
      <label for="phone">Phone Number (international format)</label>
      <input id="phone" type="text" placeholder="+1234567890" />
      <div class="row" style="margin-top: .5rem;">
        <button id="pair" class="secondary">Request Pairing Code</button>
      </div>
      <p><small>Pairing works when WA_PAIRING_MODE=pair.</small></p>
    </div>
  </div>
</body>
</html>
